<!--room.wxml-->
<view class="container">
  <!-- æˆ¿é—´ä¿¡æ¯å¤´éƒ¨ -->
  <view class="room-header">
    <view class="room-info">
      <text class="room-name">{{roomInfo.name}}</text>
      <text class="room-details">{{roomInfo.gameType}} Â· {{roomInfo.players.length}}/{{roomInfo.maxPlayers}}äºº</text>
    </view>
    <view class="room-actions">
      <button wx:if="{{isHost}}" class="btn-share" bindtap="shareRoom">
        <view class="share-icon-wrapper">
          <text class="share-icon">ğŸ”—</text>
        </view>
        <text class="share-text">åˆ†äº«</text>
      </button>
    </view>
  </view>

  <!-- ç©å®¶åˆ—è¡¨ -->
  <view class="players-section">
    <view class="section-title">
      <text class="title-text">ç©å®¶åˆ—è¡¨</text>
      <text class="title-count">({{roomInfo.players.length}}äºº)</text>
    </view>
    
    <view class="players-grid">
      <view 
        wx:for="{{roomInfo.players}}" 
        wx:key="playerId" 
        class="player-card {{item.playerId === currentPlayerId ? 'current-player' : ''}}"
        bindtap="selectPlayer"
        data-player="{{item}}"
      >
        <view class="player-avatar-container">
          <image class="player-avatar" src="{{item.avatarUrl || '/images/default-avatar.svg'}}" />
          <view wx:if="{{item.isHost}}" class="host-badge">æˆ¿ä¸»</view>
        </view>
        <view class="player-info">
          <text class="player-name">{{item.nickName}}</text>
          <view class="score-container">
            <text class="score-label">åˆ†æ•°</text>
            <text class="score-value {{item.score >= 0 ? 'positive' : 'negative'}}">
              {{item.score >= 0 ? '+' : ''}}{{item.score}}
            </text>
          </view>
        </view>
        <view class="select-indicator">
          <text class="select-text">{{item.playerId === currentPlayerId ? 'ç‚¹å‡»ç¼–è¾‘' : 'ç‚¹å‡»è®¡åˆ†'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- è®¡åˆ†å†å² -->
  <view class="history-section">
    <view class="section-title">
      <text class="title-text">è®¡åˆ†è®°å½•</text>
      <text class="title-count">({{scoreHistory.length}}æ¡)</text>
    </view>
    
    <view wx:if="{{scoreHistory.length === 0}}" class="empty-history">
      <text class="empty-text">æš‚æ— è®¡åˆ†è®°å½•</text>
    </view>
    
    <view wx:else class="history-list">
      <view 
        wx:for="{{scoreHistory}}" 
        wx:key="id" 
        class="history-item"
      >
        <view class="history-content">
          <text class="history-text">
            {{item.fromPlayer}} å‘ {{item.toPlayer}} è½¬åˆ† {{item.score}}
          </text>
          <text class="history-time">{{item.time}}</text>
        </view>
        <view class="history-score {{item.score >= 0 ? 'positive' : 'negative'}}">
          {{item.score >= 0 ? '+' : ''}}{{item.score}}
        </view>
      </view>
    </view>
  </view>

  <!-- åº•éƒ¨æ“ä½œæ  -->
  <view class="bottom-bar">
    <button class="btn-primary" bindtap="exitRoom">
      é€€å‡ºæˆ¿é—´
    </button>
  </view>
</view>

<!-- åˆ†äº«æˆ¿é—´å¼¹çª— -->
<view wx:if="{{showShareModal}}" class="modal-overlay" bindtap="closeShareModal">
  <view class="share-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">åˆ†äº«æˆ¿é—´</text>
      <button class="modal-close" bindtap="closeShareModal">Ã—</button>
    </view>
    
    <view class="share-content">
      <view class="qr-container">
        <canvas 
          canvas-id="qrcode" 
          class="qr-canvas"
          style="width: {{qrSize}}px; height: {{qrSize}}px;"
        ></canvas>
      </view>
      
      <view class="room-share-info">
        <text class="share-room-name">{{roomInfo.name}}</text>
        <text class="share-room-id">æˆ¿é—´ID: {{roomInfo.roomId}}</text>
        <text class="share-hint">è¯·å…¶ä»–ç©å®¶æ‰«æäºŒç»´ç åŠ å…¥æˆ¿é—´</text>
      </view>
    </view>
    
    <view class="share-actions">
      <button class="btn-primary share-btn" bindtap="closeShareModal">çŸ¥é“äº†</button>
    </view>
  </view>
</view>

<!-- è®¡åˆ†å¼¹çª— -->
<view wx:if="{{showScoreModal}}" class="modal-overlay" bindtap="closeScoreModal">
  <view class="score-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">å‘ {{selectedPlayer.nickName}} è®¡åˆ†</text>
      <button class="modal-close" bindtap="closeScoreModal">Ã—</button>
    </view>
    
    <view class="modal-content">
      <view class="score-input-section">
        <text class="input-label">è¾“å…¥åˆ†æ•°</text>
        <input 
          class="score-input" 
          type="number" 
          placeholder="è¯·è¾“å…¥åˆ†æ•°" 
          value="{{inputScore}}"
          bindinput="onScoreInput"
          focus="{{showScoreModal}}"
        />
        <text class="input-hint">æ­£æ•°è¡¨ç¤ºä½ è¾“ç»™å¯¹æ–¹ï¼Œè´Ÿæ•°è¡¨ç¤ºå¯¹æ–¹è¾“ç»™ä½ </text>
      </view>
      
      <view class="quick-scores">
        <text class="quick-label">å¿«é€Ÿé€‰æ‹©</text>
        <view class="quick-buttons">
          <button 
            wx:for="{{quickScores}}" 
            wx:key="*this" 
            class="quick-btn {{inputScore == item ? 'active' : ''}}"
            bindtap="selectQuickScore"
            data-score="{{item}}"
          >
            {{item > 0 ? '+' : ''}}{{item}}
          </button>
        </view>
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="btn-secondary modal-btn" bindtap="closeScoreModal">å–æ¶ˆ</button>
      <button class="btn-primary modal-btn" bindtap="confirmScore" disabled="{{!inputScore}}">ç¡®è®¤</button>
    </view>
  </view>
</view>

<!-- ç¼–è¾‘ç”¨æˆ·ä¿¡æ¯å¼¹çª— -->
<view wx:if="{{showEditModal}}" class="modal-overlay" bindtap="closeEditModal">
  <view class="edit-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">ç¼–è¾‘ä¸ªäººä¿¡æ¯</text>
      <button class="modal-close" bindtap="closeEditModal">Ã—</button>
    </view>
    
    <view class="modal-content">
      <!-- æ˜µç§°ç¼–è¾‘ -->
      <view class="nickname-section">
        <text class="input-label">æ˜µç§°</text>
        <input 
          class="nickname-input" 
          type="text" 
          placeholder="è¯·è¾“å…¥æ˜µç§°" 
          value="{{editNickName}}"
          bindinput="onNickNameInput"
          maxlength="10"
          focus="{{showEditModal}}"
        />
        <text class="input-hint">æ˜µç§°ä¸èƒ½è¶…è¿‡10ä¸ªå­—ç¬¦</text>
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="btn-secondary modal-btn" bindtap="closeEditModal">å–æ¶ˆ</button>
      <button class="btn-primary modal-btn" bindtap="confirmEdit" disabled="{{!editNickName}}">ç¡®è®¤ä¿®æ”¹</button>
    </view>
  </view>
</view>