<!--room.wxml-->
<view class="container">
  <!-- 房间信息头部 -->
  <view class="room-header">
    <view class="room-info">
      <text class="room-name">{{roomInfo.name}}</text>
      <text class="room-details">{{roomInfo.gameType}} · {{roomInfo.players.length}}/{{roomInfo.maxPlayers}}人</text>
    </view>
    <view class="room-actions">
      <button wx:if="{{isHost}}" class="btn-share" bindtap="shareRoom">
        <view class="share-icon-wrapper">
          <text class="share-icon">🔗</text>
        </view>
        <text class="share-text">分享</text>
      </button>
    </view>
  </view>

  <!-- 玩家列表 -->
  <view class="players-section">
    <view class="section-title">
      <text class="title-text">玩家列表</text>
      <text class="title-count">({{roomInfo.players.length}}人)</text>
    </view>
    
    <view class="players-grid">
      <view 
        wx:for="{{roomInfo.players}}" 
        wx:key="playerId" 
        class="player-card {{item.playerId === currentPlayerId ? 'current-player' : ''}}"
        bindtap="selectPlayer"
        data-player="{{item}}"
      >
        <view wx:if="{{item.isHost}}" class="host-badge">房主</view>
        <view class="player-avatar-container">
          <image class="player-avatar" src="{{item.avatarUrl || '/images/default-avatar.svg'}}" />
        </view>
        <view class="player-info">
          <view class="player-name-row">
            <text class="player-name">{{item.nickName}}</text>
          </view>
          <view class="score-container">
            <text class="score-label">分数</text>
            <text class="score-value {{item.score >= 0 ? 'positive' : 'negative'}}">
              {{item.score >= 0 ? '+' : ''}}{{item.score}}
            </text>
          </view>
        </view>
        <view class="select-indicator">
          <text class="select-text">{{item.playerId === currentPlayerId ? '点击编辑' : '点击计分'}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 计分历史 -->
  <view class="history-section">
    <view class="section-title">
      <text class="title-text">计分记录</text>
      <text class="title-count">({{scoreHistory.length}}条)</text>
    </view>
    
    <view wx:if="{{scoreHistory.length === 0}}" class="empty-history">
      <text class="empty-text">暂无计分记录</text>
    </view>
    
    <view wx:else class="history-list">
      <view 
        wx:for="{{scoreHistory}}" 
        wx:key="id" 
        class="history-item"
      >
        <view class="history-content">
          <text class="history-text">
            {{item.fromPlayer}} 向 {{item.toPlayer}} 转分 {{item.score}}
          </text>
          <text class="history-time">{{item.time}}</text>
        </view>
        <view class="history-score {{item.score >= 0 ? 'positive' : 'negative'}}">
          {{item.score >= 0 ? '+' : ''}}{{item.score}}
        </view>
      </view>
    </view>
  </view>

  <!-- 底部操作栏 -->
  <view class="bottom-bar">
    <button class="btn-primary" bindtap="exitRoom">
      退出房间
    </button>
  </view>
</view>

<!-- 分享房间弹窗 -->
<view wx:if="{{showShareModal}}" class="modal-overlay" bindtap="closeShareModal">
  <view class="share-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">邀请好友</text>
      <button class="modal-close" bindtap="closeShareModal">×</button>
    </view>
    
    <view class="share-content">
      <!-- 房间信息卡片 -->
      <view class="room-info-card">
        <view class="room-card-header">
          <text class="room-card-name">{{roomInfo.name}}</text>
          <text class="room-card-type">{{roomInfo.gameType}}</text>
        </view>
        <view class="room-card-details">
          <view class="room-detail-item">
            <text class="detail-label">房间号</text>
            <text class="detail-value">{{roomInfo.roomId}}</text>
          </view>
          <view class="room-detail-item">
            <text class="detail-label">人数</text>
            <text class="detail-value">{{roomInfo.players.length}}/{{roomInfo.maxPlayers}}</text>
          </view>
        </view>
      </view>

      <!-- 分享方式选择 -->
      <view class="share-methods">
        <view class="share-method-item" bindtap="shareToFriend">
          <view class="method-icon share-icon">
            <text class="icon-text">💬</text>
          </view>
          <view class="method-content">
            <text class="method-title">微信分享</text>
            <text class="method-desc">分享给微信好友或群聊</text>
          </view>
        </view>
      </view>

      <!-- 二维码展示区域 -->
      <view class="qr-section">
        <text class="qr-title">扫码加入房间</text>
        <view class="qr-container">
          <canvas 
            canvas-id="qrcode" 
            class="qr-canvas"
            style="width: {{qrSize}}px; height: {{qrSize}}px;"
          ></canvas>
        </view>
        <text class="qr-hint">好友扫描此二维码即可直接加入房间</text>
      </view>
    </view>
    
    <view class="share-actions">
      <button class="btn-primary share-btn" bindtap="closeShareModal">知道了</button>
    </view>
  </view>
</view>

<!-- 计分弹窗 -->
<view wx:if="{{showScoreModal}}" class="modal-overlay" bindtap="closeScoreModal">
  <view class="score-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">向 {{selectedPlayer.nickName}} 计分</text>
      <button class="modal-close" bindtap="closeScoreModal">×</button>
    </view>
    
    <view class="modal-content">
      <view class="score-input-section">
        <text class="input-label">输入分数</text>
        <input 
          class="score-input" 
          type="number" 
          placeholder="请输入分数" 
          value="{{inputScore}}"
          bindinput="onScoreInput"
          focus="{{showScoreModal}}"
        />
        <text class="input-hint">正数表示你输给对方，负数表示对方输给你</text>
      </view>
      
      <view class="quick-scores">
        <text class="quick-label">快速选择</text>
        <view class="quick-buttons">
          <button 
            wx:for="{{quickScores}}" 
            wx:key="*this" 
            class="quick-btn {{inputScore == item ? 'active' : ''}}"
            bindtap="selectQuickScore"
            data-score="{{item}}"
          >
            {{item > 0 ? '+' : ''}}{{item}}
          </button>
        </view>
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="btn-secondary modal-btn" bindtap="closeScoreModal">取消</button>
      <button class="btn-primary modal-btn" bindtap="confirmScore" disabled="{{!inputScore}}">确认</button>
    </view>
  </view>
</view>

<!-- 编辑用户信息弹窗 -->
<view wx:if="{{showEditModal}}" class="modal-overlay" bindtap="closeEditModal">
  <view class="edit-modal" catchtap="stopPropagation">
    <view class="modal-header">
      <text class="modal-title">编辑个人信息</text>
      <button class="modal-close" bindtap="closeEditModal">×</button>
    </view>
    
    <view class="modal-content">
      <!-- 头像选择 -->
      <view class="avatar-section">
        <text class="input-label">头像</text>
        <view class="avatar-selector">
          <button class="avatar-btn" open-type="chooseAvatar" bindchooseavatar="onChooseAvatar">
            <image class="edit-avatar" src="{{editAvatarUrl || '/images/default-avatar.svg'}}" />
            <view class="avatar-overlay">
              <text class="avatar-text">点击更换</text>
            </view>
          </button>
        </view>
        <text class="input-hint">点击头像可更换为微信头像</text>
      </view>
      
      <!-- 昵称编辑 -->
      <view class="nickname-section">
        <text class="input-label">昵称</text>
        <input 
          class="nickname-input" 
          type="nickname"
          placeholder="请输入昵称" 
          value="{{editNickName}}"
          bindinput="onNickNameInput"
          maxlength="10"
          focus="{{showEditModal}}"
        />
        <text class="input-hint">昵称不能超过10个字符</text>
      </view>
    </view>
    
    <view class="modal-actions">
      <button class="btn-secondary modal-btn" bindtap="closeEditModal">取消</button>
      <button class="btn-primary modal-btn" bindtap="confirmEdit" disabled="{{!editNickName}}">确认修改</button>
    </view>
  </view>
</view>